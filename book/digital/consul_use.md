# Введение в использование Consul, системы обнаружения сервисов, в Ubuntu 14.04

Опубликовано 15 августа 2014 г. 156.3k просмотров [Сеть](https://www.digitalocean.com/community/tags/networking?type=tutorials) [Ubuntu](https://www.digitalocean.com/community/tags/ubuntu?type=tutorials)

*    [![jellingwood](https://secure.gravatar.com/avatar/60d901f61a6146e14a3e989bc1f4ef11?secure=true&d=identicon)](https://www.digitalocean.com/community/users/jellingwood)
*   По [Джастин Эллингвуд](https://www.digitalocean.com/community/users/jellingwood)

    [Стать автором](https://www.digitalocean.com/community/write-for-digitalocean)

### Введение

**Consul** \- это распределенная, высокодоступная, ориентированная на центры обработки данных, система обнаружения и настройки служб. Его можно использовать для представления сервисов и узлов в гибком и мощном интерфейсе, который позволяет клиентам всегда иметь актуальное представление об инфраструктуре, частью которой они являются.

Консул предоставляет множество различных функций, которые используются для предоставления согласованной и доступной информации о вашей инфраструктуре. Это включает в себя механизмы обнаружения служб и узлов, систему тегов, проверки работоспособности, процедуры выбора на основе консенсуса, общесистемное хранение ключей / значений и многое другое. Используя консул в своей организации, вы можете легко внедрить сложный уровень осведомленности в свои приложения и услуги.

В этом руководстве мы познакомим вас с некоторыми основами использования консула. Мы рассмотрим общие процедуры, необходимые для запуска консула на ваших серверах, чтобы протестировать его. В следующем руководстве мы сосредоточимся на настройке консула в производственной среде.

## Предпосылки и цели

В этом руководстве мы познакомимся с использованием консулов ​​для построения системы обнаружения и настройки служб для вашей инфраструктуры.

Для нашей демонстрации мы будем настраивать три сервера и один клиент. Серверы используются для обработки запросов и поддержания согласованного представления о системе. Клиент также является участником системы и может подключаться к серверам для получения информации об инфраструктуре. Клиенты могут также содержать услуги, которые будут контролироваться консулом.

Для целей данного руководства и всей этой серии мы будем настраивать 4 компьютера. Первые три будут **серверами консула,** как описано выше. Последний будет **агентом консула,** который действует как клиент и может использоваться для запроса информации о системе.

Чтобы реализовать некоторые механизмы безопасности на более позднем этапе, нам нужно назвать все наши машины в одном домене. Это сделано для того, чтобы в будущем мы могли использовать SSL\-сертификат с подстановочными знаками.

Детали наших машин здесь:

| Hostname | Айпи адрес | Роль |
| --- | --- | --- |
| server1.example.com | 192.0.2.1 | загрузочный консул сервер |
| server2.example.com | 192.0.2.2 | консул сервер |
| server3.example.com | 192.0.2.3 | консул сервер |
| agent1.example.com | 192.0.2.50 | консул\-клиент |

Для этой демонстрации мы будем использовать 64\-битные серверы Ubuntu 14.04, но любой современный сервер Linux должен работать одинаково хорошо.

## Загрузка и установка Консул

Первый шаг, который нам нужно сделать, это загрузить и установить программное обеспечение консула на каждую из наших машин. Следующие шаги должны быть предприняты на *каждой* из машин, перечисленных выше. Вы должны войти в систему как root.

Прежде чем мы заглянем в консул приложение, нам нужно получить `unzip` распаковываемый файл. Мы также будем использовать `screen` приложение, чтобы позволить нам легко иметь несколько сеансов в одном окне терминала. Это полезно для нашего введения, так как консул обычно занимает весь экран, когда не работает как сервис.

Обновите кэш пакета локальных систем, а затем установите пакет, используя `apt` :

```
apt-get update
apt-get install unzip screen

```

Поэтому мы не забываем сделать это позже, начните сеанс экрана сейчас:

```
screen

```

Нажмите ввод, если вы получаете сообщение об авторских правах. Вы попадете обратно в окно терминала, но теперь вы находитесь внутри сеанса экрана.

Теперь мы можем получить программу консула. Страница [проекта консула](http://www.consul.io/downloads.html) содержит ссылки для загрузки бинарных пакетов для Windows, OS X и Linux.

Перейдите на страницу выше и щелкните правой кнопкой мыши по операционной системе и архитектуре, которая представляет ваши серверы. В этом руководстве, поскольку мы используем 64\-битные серверы, мы будем использовать ссылку «amd64» в разделе «linux». Выберите «Копировать ссылку» или любой другой аналогичный вариант, который предоставляет ваш браузер.

В вашем терминале перейдите в `/usr/local/bin` каталог, где мы будем хранить исполняемый файл. Введите `wget` и пробел, а затем вставьте URL\-адрес, скопированный с сайта:

```
cd /usr/local/bin
wget https://dl.bintray.com/mitchellh/consul/0.3.0_linux_amd64.zip

```

Теперь мы можем извлечь двоичный пакет с помощью `unzip` команды, которую мы установили ранее. Затем мы можем удалить заархивированный файл:

```
unzip *.zip
rm *.zip

```

Теперь у вас должна быть `consul` команда доступна на всех ваших серверах.

## Запуск сервера начальной загрузки

Чтобы начать работать с консулом, нам нужно настроить и запустить наши серверы консула. При настройке этого в рекомендуемой многосерверной среде этот шаг должен быть выполнен поэтапно.

Первое , что нам нужно сделать , это запустить программу консулом на одном из наших серверов в `server` и `bootstrap` режиме. Режим сервера означает, что консул будет запускаться как экземпляр сервера, а не как клиент. Опция начальной загрузки используется для первого сервера. Это позволяет ему назначать себя «лидером» для кластера без выборов (поскольку он будет единственным доступным сервером).

В таблице, которая указывает наши хосты, мы определили наш `server1` как сервер начальной загрузки. На сервере server1 запустите экземпляр начальной загрузки, набрав:

```
consul agent -server -bootstrap -data-dir /tmp/consul

```

Сервер запустится в текущем терминале и данные журнала будут выводиться по мере возникновения событий. В конце данных журнала вы увидите следующие строки:

```
. . .
2014/07/07 14:32:15 [ERR] agent: failed to sync remote state: No cluster leader
2014/07/07 14:32:17 [WARN] raft: Heartbeat timeout reached, starting election
2014/07/07 14:32:17 [INFO] raft: Node at 192.0.2.1:8300 [Candidate] entering Candidate state
2014/07/07 14:32:17 [INFO] raft: Election won. Tally: 1
2014/07/07 14:32:17 [INFO] raft: Node at 192.0.2.1:8300 [Leader] entering Leader state
2014/07/07 14:32:17 [INFO] consul: cluster leadership acquired
2014/07/07 14:32:17 [INFO] consul: New leader elected: server1.example.com
2014/07/07 14:32:17 [INFO] consul: member 'server1.example.com' joined, marking health alive

```

Как видите, лидер кластера не найден, так как это начальный узел. Однако, поскольку мы включили опцию начальной загрузки, этот сервер смог самостоятельно войти в состояние лидера, чтобы инициировать кластер с одним хостом.

## Запуск других серверов

На `server2` и `server3` теперь мы можем запустить консул *без* опции начальной загрузки, набрав:

```
consul agent -server -data-dir /tmp/consul

```

Для этих серверов вы также увидите записи в журнале. К концу вы увидите такие сообщения:

```
. . .
2014/07/07 14:37:25 [ERR] agent: failed to sync remote state: No cluster leader
2014/07/07 14:37:27 [WARN] raft: EnableSingleNode disabled, and no known peers. Aborting election.
2014/07/07 14:37:53 [ERR] agent: failed to sync remote state: No cluster leader

```

Это происходит потому, что он не может найти лидера кластера и не может сам стать лидером. Это состояние происходит потому, что наш второй и третий сервер включены, но ни один из наших серверов еще не связан друг с другом.

Чтобы соединиться друг с другом, нам нужно соединить эти серверы друг с другом. Это можно сделать в любом направлении, но самое простое из нашей `server1` машины.

Так как мы работаем с консул\-сервером в текущем окне терминала `server1` , нам нужно будет создать еще один терминал `screen` для выполнения дополнительной работы. Создайте новое окно терминала в рамках существующего сеанса экрана `server1` , набрав:

```
CTRL-A C

```

Это откроет новый экземпляр терминала, сохраняя при этом нашу предыдущую сессию. Вы можете пройти через все существующие сеансы терминала, набрав:

```
CTRL-A N

```

Вернувшись в свой новый терминал, присоединитесь к двум другим экземплярам, ​​указав их IP\-адреса следующим образом:

```
consul join 192.0.2.2 192.0.2.3

```

Это должно немедленно объединить все три сервера в один кластер. Вы можете проверить это дважды, набрав:

```
consul members

```

```
Node                 Address             Status  Type    Build  Protocol
server1.example.com  192.0.2.1:8301  alive   server  0.3.0  2
server2.example.com  192.0.2.2:8301  alive   server  0.3.0  2
server3.example.com  192.0.2.3:8301  alive   server  0.3.0  2

```

Вы также можете получить эту информацию с любого из других серверов, создав новый сеанс терминала на экране, как мы описали выше, и выполнив ту же команду.

## Удаление сервера начальной загрузки и повторное присоединение в качестве обычного сервера

Все три наших сервера объединены в кластер, но мы еще не закончили.

В настоящее время, поскольку он `server1` был запущен в режиме начальной загрузки, он может принимать решения, не обращаясь к другим серверам. Поскольку они должны работать как равные и принимать решения по кворуму, мы хотим удалить эту привилегию после того, как кластер был загружен.

Для этого нам нужно остановить службу консула `server1` . Это позволит оставшимся машинам выбрать нового лидера. Затем мы можем перезапустить консул `server1` без использования опции начальной загрузки и снова присоединиться к кластеру.

На сервере 1 вернитесь к терминалу с консулом:

```
CTRL-A N

```

Остановите службу, набрав:

```
CTRL-C

```

Теперь перезапустите сервис без опции начальной загрузки:

```
consul agent -server -data-dir /tmp/consul

```

Вернитесь к открытому терминалу и присоединитесь к кластеру, подключившись к одному из двух серверов в кластере:

```
CTRL-A N
consul join 192.0.2.2

```

Теперь у вас должно быть три равных сервера. Они будут реплицировать информацию друг другу и будут обрабатывать ситуации, когда один сервер становится недоступным. Дополнительные серверы теперь могут также присоединяться к кластеру, просто запустив сервер без начальной загрузки и присоединившись к кластеру.

## Присоединение к кластеру в качестве клиента и обслуживание веб\-интерфейса

Теперь, когда кластер серверов доступен, мы можем продолжить и подключиться с помощью клиентского компьютера.

Мы собираемся разместить веб\-интерфейс консула на нашем клиентском компьютере, чтобы мы могли взаимодействовать с кластером и отслеживать его работоспособность. Для этого [посетите страницу загрузки для веб\-интерфейса](http://www.consul.io/downloads_web_ui.html) . Щелкните правой кнопкой мыши по кнопке загрузки и выберите «Копировать местоположение ссылки» или любой другой подобный вариант, который у вас есть.

На вашем клиентском компьютере перейдите в домашний каталог. Введите `wget` и пробел, а затем вставьте скопированный URL\-адрес со страницы:

```
cd ~
wget https://dl.bintray.com/mitchellh/consul/0.3.0_web_ui.zip

```

Когда загрузка будет завершена, разархивируйте и удалите архив:

```
unzip *.zip
rm *.zip

```

Там будет каталог с именем `dist` , содержащий все файлы, необходимые для отображения веб\-интерфейса консула. Нам просто нужно указать этот каталог, когда мы подключаемся к кластеру.

Чтобы подключиться к кластеру, мы будем использовать аналогичный вызов консула агента, который мы использовали для серверов. Однако мы будем использовать разные флаги.

Мы не будем использовать `server` флаг, так как хотим работать в режиме клиента. По умолчанию клиентский интерфейс каждого узла доступен через локальный петлевой интерфейс. Поскольку мы хотим получить удаленный доступ к веб\-интерфейсу, вместо этого мы должны указать публичный IP\-адрес клиента.

Нам нужно будет указать консула каталог, в котором находится веб\-интерфейс, чтобы обслуживать этот контент. Кроме того, мы собираемся присоединиться к кластеру сразу же, передав IP\-адрес одного из серверов в кластере. Это позволит нам избежать необходимости присоединяться впоследствии. Мы могли бы сделать это и раньше на примере сервера.

В конце концов, наша команда соединения довольно длинная. Это будет выглядеть так:

```
consul agent -data-dir /tmp/consul -client 192.0.2.50 -ui-dir /home/your_user/dir -join 192.0.2.1

```

Это подключит наш клиентский компьютер к кластеру как обычный, не серверный агент. Этот агент будет отвечать на запросы по своему общедоступному IP\-адресу вместо обычного `127.0.0.1` интерфейса. Из\-за этого вам нужно будет добавить дополнительный флаг к любым командам консула, указав `rpc-addr` .

Например, если вы хотите запросить список участников у клиента, вам нужно будет сделать это, указав альтернативный интерфейс и выбранный вами порт:

```
consul members -rpc-addr=192.0.2.50:8400

```

```
Node     Address             Status  Type    Build  Protocol
agent1   192.0.2.50:8301    alive   client  0.3.0  2
server2  192.0.2.2:8301  alive   server  0.3.0  2
server1  192.0.2.1:8301  alive   server  0.3.0  2
server3  192.0.2.3:8301  alive   server  0.3.0  2

```

Это может показаться хлопотным, но дает нам возможность получить доступ к веб\-интерфейсу консула. Вы можете получить доступ к веб\-интерфейсу, посетив IP\-адрес вашего клиента, а затем `:8500/ui` в вашем веб\-браузере:

```
http://192.0.2.50:8500/ui

```

Основной интерфейс будет выглядеть так:

![Целевая страница веб-интерфейса Consul](https://assets.digitalocean.com/articles/consul_intro/consul_default.png)

Вы можете просматривать различные меню и изучать интерфейс. Это дает вам хороший способ визуализации вашего кластера и состояния ваших машин и сервисов.

## Добавление услуг и проверок

Теперь мы хотим добавить сервисы в консул, который является основным вариантом использования для настройки этого. Вы можете добавлять сервисы несколькими способами, но проще всего создать каталог конфигурации для хранения определений ваших сервисов.

Служба связана с узлом, который содержит определение службы. Поэтому, если у нас есть веб\-сервер, мы должны установить консул на этом сервере и создать там файл определения сервиса.

Для наших целей мы установим Nginx на нашем клиенте, чтобы продемонстрировать это. Убейте текущий сеанс клиента, набрав:

```
CTRL-C

```

Установите Nginx на клиенте, набрав:

```
apt-get install nginx

```

Теперь мы можем создать каталог конфигурации для хранения определений наших сервисов:

```
mkdir ~/services

```

Внутри этого каталога мы создадим файл JSON, который описывает наш веб\-сервис. Мы назовем это `web.json` :

```
nano ~/services/web.json

```

Внутри этого файла нам нужно включить структуру для определения нашего сервиса. В рамках этой структуры мы определим подструктуру для проверки работоспособности сервиса, чтобы мы могли достоверно определить, работает он или нет.

Основная схема выглядит следующим образом:

```
{
    "service": {
        . . .
        "check": {
            . . .
        }
    }
}

```

Для сервиса нам нужно определить имя сервиса и сообщить консулу, какой порт он должен проверять. Кроме того, мы можем предоставить ему список тегов, которые мы можем использовать для произвольной категоризации сервиса для наших собственных целей сортировки.

Для нашего примера это выглядит так:

```
{
    "service": {
        "name": "web server",
        "port": 80,
        "tags": ["nginx", "demonstration"],
        "check": {
            . . .
        }
    }
}

```

Это все, что нам нужно, чтобы определить сам сервис. Однако мы также хотим определить метод, с помощью которого консул может проверить работоспособность службы. Обычно это довольно просто и повторяет обычные проверки системного администратора.

Для нашего сервиса мы будем реализовывать простой веб\-запрос с `curl` использованием списков проектов консула в [собственной документации](http://www.consul.io/intro/getting-started/checks.html) . На самом деле нам не нужно знать, что curl может извлечь, нам важно только, была ли команда выполнена без ошибок. Из\-за этого мы можем выбросить любой вывод.

Нам также нужно установить интервал, через который будет выполняться проверка. Это всегда компромисс между производительностью и актуальной информацией. Мы будем использовать 10 секунд, так как мы хотим относительно скоро узнать, если что\-то не так:

```
{
    "service": {
        "name": "web server",
        "port": 80,
        "tags": ["nginx", "demonstration"],
        "check": {
            "script": "curl localhost:80 > /dev/null 2>&1",
            "interval": "10s"
        }
    }
}

```

Сохраните и закройте файл, когда вы закончите.

Теперь мы можем просто перезапустить сеанс консула клиента и указать на этот каталог как имеющий определения службы:

```
consul agent -data-dir /tmp/consul -client 192.0.2.50 -ui-dir /home/your_user/dist -join 192.0.2.1 -config-dir /home/your_user/services

```

Это перезапустит узел и подключит его к кластеру. Если вы вернетесь к веб\-интерфейсу, теперь вы должны увидеть сервис:

![Консул интро сервис](https://assets.digitalocean.com/articles/consul_intro/service.png)

Вернувшись на свой клиент, вы можете создать новый терминал и временно остановить веб\-сервер:

```
CTRL-A C
service nginx stop

```

Когда вы обновляете веб\-интерфейс, вы видите, что проверка веб\-службы теперь не выполняется, как и ожидалось:

![Консул интро не удалось сервис](https://assets.digitalocean.com/articles/consul_intro/failed_service.png)

Это показывает, что наша проверка здоровья работает, как ожидалось.

## Вывод

Теперь у вас должно быть базовое представление о том, как работает консул. Демонстрация, которую мы представили в этом руководстве, не совсем лучший способ работы с консулом на производстве, но она использовалась, чтобы позволить вам быстро увидеть полезные функции программного обеспечения.

В [следующем руководстве](https://www.digitalocean.com/community/tutorials/how-to-configure-consul-in-a-production-environment-on-ubuntu-14-04) мы рассмотрим, как использовать консул в производственной среде. Мы поместим все наши детали конфигурации в файлы для удобства пользования и создадим сценарии запуска для запуска службы при загрузке.
